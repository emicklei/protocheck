// Code generated by protoc-gen-protocheck. DO NOT EDIT.

package {{.PkgName}};

import org.emicklei.protocheck.Checker;
import org.emicklei.protocheck.MessageValidator;
import org.emicklei.protocheck.ValidationException;

import dev.cel.common.CelValidationException;
import dev.cel.common.types.SimpleType;
import dev.cel.common.types.StructTypeReference;
import dev.cel.compiler.CelCompiler;
import dev.cel.compiler.CelCompilerFactory;
import dev.cel.runtime.CelEvaluationException;
import dev.cel.runtime.CelRuntime.Program;

public final class {{.JavaOuterClassname}}Checkers {
    private {{.JavaOuterClassname}}Checkers() {}

    {{- range .Messages}}
    private static MessageValidator<{{.MessageName}}> {{.LowercaseMessageName}}Validator= new MessageValidator<{{.MessageName}}>();
    
    static { 
        try {
            CelCompiler compiler = CelCompilerFactory.standardCelCompilerBuilder()
                    .addMessageTypes({{.MessageName}}.getDescriptor())
                    .addVar("this", StructTypeReference.create({{.MessageName}}.getDescriptor().getFullName()))
                    .setStandardEnvironmentEnabled(true)
                    .setResultType(SimpleType.BOOL)
                    .build();
            {{- $lowerName := .LowercaseMessageName}}                                        
            {{- range .MessageCheckers }}	
	        { // {{.Comment}}
                String expr = "{{.Expr}}";
                Program prog = Checker.makeProgram(compiler.compile(expr).getAst());
                Checker checker = new Checker("{{.ID}}","{{.Fail}}",expr,prog,"{{.FieldName}}",{{.IsOptional}});            
                {{$lowerName}}Validator.addMessageChecker(checker);
            }
            {{- end}}
            {{- range .FieldCheckers }}
            { // {{.Comment}}
                String expr = "{{.Expr}}";
                Program prog = Checker.makeProgram(compiler.compile(expr).getAst());
                Checker checker = new Checker("{{.ID}}","{{.Fail}}",expr,prog,"{{.FieldName}}",{{.IsOptional}});            
                {{$lowerName}}Validator.addFieldChecker(checker);
            }
            {{- end}}
        } catch (CelEvaluationException ex) {
            System.err.println("CelEvaluationException: " + ex.getMessage());
            throw new RuntimeException(ex.getCause());

        } catch (CelValidationException ex) {
            System.err.println("CelValidationException: " + ex.getMessage());
            throw new RuntimeException(ex.getCause());
        }
    }

    public static void validate({{.MessageName}} x) throws ValidationException {
        if (x == null) { return; }
        {{.LowercaseMessageName}}Validator.validate(x);
        {{- range .MessageFieldNames}}	
        //for _ , nve := range protocheck.AsValidationError(x.Get{{.}}().Validate()) { // {{.}}
        //    ve = append(ve, nve.WithPath(".{{.}}"))
        //}
        {{- end}}	        
    }
    {{- end }}
}